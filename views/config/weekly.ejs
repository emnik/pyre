<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="/stylesheets/select2.css" />
		<link rel="stylesheet" href="/stylesheets/select2-width-fix.css"
		<% include ../partials/head %>
	</head>

<body>
	<header>
		<% include ../partials/header_edits %>
	</header>

	<div class="container-fluid">
		<%schedule.forEach(function(day){%>
		<%if(day.daynum==0 || day.daynum==4){%> <!--Define a row before Sunday and a second row before Thursday -->
		<div class="row"> 
		<%}%>
			<div class="col-xs-12 col-md-3 col-lg-3">
				<div class="panel panel-default">
				  <!-- Default panel contents -->
				  <div class="panel-heading">
				  	<span id="day<%=day.daynum%>"><span>
				  </div>
				  <div class="panel-body">
				    <p>
				    	<select id="timewindows" class="form-control" style="width:100%;" name="timewindows">
				    		<option></option>
							<optgroup label="Available time windows:">
				    		<% timewindow.forEach(function(item){ %>
							  <option value="<%=item.id%>">
							  	<%=item.name%> <!-- (<%=item.on_time%>-<%=item.off_time%>) : <%=item.temp%>&degC -->
							  </option>
							<%});%>
							</optgroup>
				    	</select>
				    </p>
				  </div>

				  <!-- List group -->
				  <ul id="windowlist<%=day.daynum%>" class="list-group">
				  <% timewindowsperday.forEach(function (window){
				  	if (window.day == day.daynum){%>
				  		<li id="windowlist<%=day.daynum%>-window<%=window.id%>" class="list-group-item">
				  			<h4 class="list-group-item-heading">
				  				<%=window.name%> : <small><%=window.on_time+"-"+window.off_time%></small>

				  			</h4>
				  			<span class="label-group">
				  			<%var arr=window.sensor_ids.split(',');
							arr.forEach(function(i){
								sensors.forEach(function(j){
									if(j.id == i){%>
										<span class="label label-default ">
										<%=j.location%>
										</span>	
									<%}
								})
							})%>
							</span>
							<span style="padding-left:10px;"><%=window.temp%> &degC</span>
							<a href='#windowlist<%=day.daynum%>-window<%=window.id%>' onclick="windowremove('#windowlist<%=day.daynum%>-window<%=window.id%>')" style="color:black;"><span style="margin-top:-15px;" class="pull-right glyphicon glyphicon-remove"></span></a>
				  		</li>
				  	<%}
				  })%>
				  </ul>
				</div>
			</div>	
		<%if(day.daynum==3 || day.daynum==6){%> <!--Close the first row after Wednesday and the second after Saturday! -->
		</div>
		<%}%>
		<%})%>
		<div class="row" style="padding-bottom:20px;">
			<div class="col-xs-12 col-md-12 col-lg-12">
				<button id="resetbtn" type="button" class="btn btn-danger pull-left">Reset</button>
					<button id="setbtn" type="button" class="btn btn-success pull-right">Set</button>
			</div>
		</div>
	</div>

</body>

<% include ../partials/javascript.ejs %>

<script src="/javascripts/select2/select2.min.js"> </script>
<script src="/javascripts/custom.js"></script>

<script>
	$(document).ready(function(){
		var prevtimewindows = get_current_timewindows();
		
		$('[name="timewindows"]').select2({
			minimumResultsForSearch: Infinity,
			placeholder: "Select a time window to add"
		});


		<%schedule.forEach(function(item){%>
			var day = dayOfWeekAsInteger(<%=item.daynum%>);
			$('#day<%=item.daynum%>').text(day);
		<%})%>

		$('[name="timewindows"]').on('change', function(){
			var timewindows_id = this.value;
			console.log($(this));
			var listgroup = $(this).parent().parent().next();
			var listgroup_id = listgroup.attr('id');
			$.ajax({
				type: "POST",
				contentType: "application/json; charset=utf-8", 
				url: "/edit/get_timewindow_by_id",
				data: JSON.stringify({id:timewindows_id}),
				success: function(rdata) { //rdata = remote data that the server sends as feedback...
					// console.log(rdata.result);
					if (rdata.result==="ok"){
						console.log("success");
						var timewindow = rdata.timewindow[0];
				  		var html = "<li id='"+listgroup_id+"-window"+timewindow.id+"'"+"class='list-group-item'>"+
				  			"<h4 class='list-group-item-heading'>"+
				  				timewindow.name +" : <small>"+timewindow.on_time+"-"+timewindow.off_time+"</small>"+
				  			"</h4>"+
				  			"<span class='label-group'>"+
								"<span class='label label-default'>"+
										timewindow.sensor_ids+
								"</span>"+
							"</span>"+
							"<span style='padding-left:10px;'>"+timewindow.temp+"&degC</span>"+
							"<a href='#"+listgroup_id+"-window"+timewindow.id+"' onclick=windowremove('#"+listgroup_id+"-window"+timewindow.id+"') style='color:black;'><span style='margin-top:-15px;' class='pull-right glyphicon glyphicon-remove'></span></a>"+
				  		"</li>"
						listgroup.append(html);
						// $("#setbtn").empty();
						// $("#setbtn").append('Set <span class="glyphicon glyphicon-ok"</span>');
					}
					else
					{
						console.log('error');
						// $("#setbtn").empty();
						// $("#setbtn").append('Error <span class="glyphicon glyphicon-alert"</span>');
					}
				},
				dataType: "json" // dataType is what you're expecting back from the server: json, html, text,
			});
			$(this).val(null).trigger('change.select2');
		})


		$('#setbtn').click(function(){
			var curtimewindows = get_current_timewindows();
			console.log(curtimewindows);
			updatetimetable(curtimewindows);
		})



	}) //end of $(document).ready()

	function windowremove(id){
		$(id).remove();
	}

	function get_current_timewindows(){
		var timewindows=[0,1,2,3,4,5,6];
			var window_id=[];
			var myRe =  new RegExp('windowlist[0-9]-window([0-9]+)');
			for (var day=0; day<=6; day++){
				timewindows[day]=new Array();
				$('#windowlist'+day).children('.list-group-item').each(function(){
					window_id=myRe.exec($(this).attr('id'));
					timewindows[day].push(window_id[1]);
				});
			}
		return timewindows;
	}

	function updatetimetable(arr){
		$.ajax({
			type: "POST",
			contentType: "application/json; charset=utf-8", //contentType is the type of data you're sending
			url: "/edit/update_timetable",
			data: JSON.stringify({data:arr}),
			success: function(rdata) { //rdata = remote data that the server sends as feedback...
				// console.log(rdata.result);
				if (rdata.result==="ok"){
					console.log("success");
					$("#setbtn").empty();
					$("#setbtn").append('Set <span class="glyphicon glyphicon-ok"</span>');
				}
				else
				{
					console.log('error');
					$("#setbtn").empty();
					$("#setbtn").append('Error <span class="glyphicon glyphicon-alert"</span>');
				}
			},
			dataType: "json" // dataType is what you're expecting back from the server: json, html, text,
		});
	}

</script>