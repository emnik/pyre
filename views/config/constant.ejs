<!DOCTYPE html>
<html>
	<head>
	<% include ../partials/head %>
	</head>

<body>
	<header>
		<% include ../partials/header_edits %>
		<link rel="stylesheet" href="/stylesheets/select2.css" />
	</header>

	<div class="container-fluid">
		<div class="row">
			<div class="col-xs-12 col-md-12 col-lg-12">
				<div class="panel panel-default">
					<div class="panel-heading">
						<h5>Set ALLDAY target temp and sensors</h5>
					</div>
					<div class="panel-body">
						<div class="input-group">
							<input id="setTargetTemp" type="text" value=<%=curtemp.temp%> name="setTargetTemp">
						</div>
						<div style="padding-top:15px;">
							<select id="sensors" class="form-control" style="width:100%;" name="sensors" multiple="multiple">
								<optgroup label="Sensor location:">
								<% sensors.forEach(function(item){ %>
								  <option value="<%=item.id%>"
								  <%var arr = curtemp.sensor_ids.split(',');
								  for (var i=0; i<arr.length; i++){
								  	if (item.id==arr[i]) {%> selected="selected" <%}
								  }%>><%= item.location %>
								  </option>
								 <%});%>
							 </select>
						</div>						
					</div>
				</div>		
			</div>	
		</div>

		<div class="row" style="padding-bottom:20px;">
			<div class="col-xs-12 col-md-12 col-lg-12">
				<button id="resetbtn" type="button" class="btn btn-danger pull-left">Reset</button>
				<div class="btn-group pull-right" role="group" aria-label="...">
					<button id="setbtn" type="button" class="btn btn-success">Set</button>
					<button id="morebtn" type="button" class="btn btn-success"><span class="glyphicon glyphicon-tasks"</span></button>
				</div>
			</div>
		</div>
	</div>

</body>

<% include ../partials/javascript.ejs %>
<script src="/javascripts/bootstrap.touchspin.js"></script>
<script src="/javascripts/select2/select2.min.js"></script>
<script>

	$( document ).ready(function() {

		$('#resetbtn').click(function(){
			var curvalue = $("input[name='setTargetTemp']").val();
			$("input[name='setTargetTemp']").val(<%=curtemp.temp%>);
			if (curvalue!=<%=curtemp.temp%>){
				setTemp(<%=curtemp.temp%>, '<%=curtemp.name%>');
				console.log("The target temp has been resseted to "+<%=curtemp.temp%>+" deg C.");		
			}
			else
			{
				console.log("the Temperature is the same. No need for action...");
			}
			$("#setbtn").empty();
			$("#setbtn").append('Set');
		})

		$('#setbtn').click(function(){
			$("#setbtn").empty();
			$("#setbtn").append('Set <span class="glyphicon glyphicon-ok"</span>');
			var newtemp = $("input[name='setTargetTemp']").val();
			setTemp(newtemp,'<%=curtemp.name%>');
			console.log("the Temperature is updated to "+newtemp+ "deg C.");
		})

		$('#sensors').select2({
			minimumResultsForSearch: Infinity,
			placeholder: "Select sensors"
		});

	}) //end of ( document ).ready(function()

	function setTemp(t, name){
		$.ajax({
			type: "POST",
			contentType: "application/json; charset=utf-8", //contentType is the type of data you're sending
			url: "/edit/update_temp",
			data: JSON.stringify({newtemp:t, name:name}),
			/*JavaScript Object Notation is a way to share data between applications in object format.
			However, you cannot send an object over an HTTP request without first turning it into a string
			and sending it as a single variable. The functions JSON.parse() and JSON.stringify() do this for us.*/
			success: function(rdata) { //rdata = remote data that the server sends as feedback...
				console.log(rdata.result);
				if (rdata.result==="ok"){
					console.log("success");
				}
			},
			dataType: "json" // dataType is what you're expecting back from the server: json, html, text,
		});
	}

	$("input[name='setTargetTemp']").TouchSpin({
	min: 0, // Minimum value.
	max: 100, // Maximum value.
	decimals: 1,
	boostat: 3, // Boost at every nth step.
	maxboostedstep: 10, // Maximum step when boosted.
	postfix: '&deg C', // Text after the input.
	prefix: 'TEMP :', // Text before the input.
	step: 0.1, // Incremental/decremental step on up/down change.
	stepinterval: 100, // Refresh rate of the spinner in milliseconds.
	stepintervaldelay: 500 // Time in milliseconds before the spinner starts to spin.
	});

	$("input[name='setTargetTemp']").change(function(){
		$("#setbtn").empty();
		$("#setbtn").append('Set <span class="glyphicon glyphicon-transfer"</span>');
	})

</script>